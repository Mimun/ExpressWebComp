<!DOCTYPE html>
<html lang="">

<head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Bootstrap Testbed</title>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <title>Material Design Bootstrap</title>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.2/css/all.css">
    <!-- Bootstrap core CSS -->
    <!-- <link href="css/bootstrap.min.css" rel="stylesheet"> -->
    <link href="../../node_modules/mdbootstrap/css/bootstrap.min.css" rel="stylesheet">
    <!-- Material Design Bootstrap -->
    <!-- <link href="css/mdb.min.css" rel="stylesheet"> -->
    <link href="../../node_modules/mdbootstrap/css/mdb.min.css" rel="stylesheet">
    <!-- Your custom styles (optional) -->
    <!-- <link href="css/style.css" rel="stylesheet"> -->
    <link rel="stylesheet" href="./Popper.css">


    <style>
        body {
            padding: 20px;
        }

        .list-group-item {
            cursor: move;
        }

        .chosen {
            color: #baf;
            background-color: #007bff;
        }

        /* ghostClass */
        .ghost {
            opacity: .8;
            background: #c00;
        }
    </style>


</head>

<body>
    <h1 class="text-center">Simple Sortable Within WC</h1>


    <div class="row">
        <div class="col-xs-6 col-sm-6 col-md-6 col-lg-6">
            <fieldset class="scheduler-border">
                <legend class="scheduler-border ">Create Option Set by Drag & Drop </legend>
                <sortable-wc id="Left" style = "min-height: 200px;height: 300px; ">
                    <chipl class="list-group-item" role="alert">bar 1</chipl>
                    <chipl class="list-group-item" role="alert">bar 2</chipl>
                    <chipl class="list-group-item" role="alert">bar 3</chipl>
                    <!-- <basiccomp-wc>ABCD</basiccomp-wc>
                        <basiccomp-wc/></basiccomp-wc>
                        <basiccomp-wc></basiccomp-wc>
                        <basiccomp-wc></basiccomp-wc> -->
                </sortable-wc>
            </fieldset>
        </div>
        <div class="col-xs-6 col-sm-6 col-md-6 col-lg-6">
            <fieldset class="scheduler-border">
                <legend class="scheduler-border">Input Types</legend>
                <sortable-wc id="Right" >
                    <chipl class="list-group-item" role="alert" id='tao'>foo 1</chipl>
                    <chipl class="list-group-item" role="alert">foo 2</chipl>
                    <chipl class="list-group-item" role="alert">foo 3</chipl>
                    <basiccomp-wc class="list-group-item" mode='display' data-id="meo" >
                    </basiccomp-wc>
                    <basiccomp-wc class="list-group-item" />
                    </basiccomp-wc>
                    <basiccomp-wc class="list-group-item" />
                    </basiccomp-wc>
                    <basiccomp-wc class="list-group-item" />
                    </basiccomp-wc>
                </sortable-wc>
            </fieldset>
        </div>



    </div>
    <template id="example2popper1">
        <div class="" style="padding: 0%; display: block">
            <div id="draggable-scroll" class="card">
                <h5 class="card-header success-color white-text">Draggable panel</h5>
                <div class="card-body">
                    <p class="card-text" id = "Context" ></p>
                    <!-- Should be adding automatically -->
                    <slot>
                        <basiccomp-wc mode='display' class="card-text"></basiccomp-wc>
                    </slot>
                    
                </div>
            </div>
            
        </div>
        <div class="popper__arrow"></div>
    </template>    
    <cover id = 'cover' class = "popper col-md-4 col-lg-4" style="display: none; padding: 0px"></cover>


    <script type="module" src="../BasicComponentWC/BasicComponentWC/BasicComponentWC.js"></script>
    <script src="../../node_modules/mdbootstrap/js/popper.min.js"></script>
    <script type="text/javascript" src="../../node_modules/mdbootstrap/js/jquery-3.4.1.min.js"></script>
    <!-- Bootstrap tooltips -->
    <!-- <script type="text/javascript" src="../../node_modules/mdbootstrap/js/popper.min.js"></script> -->
    <!-- Bootstrap core JavaScript -->
    <script type="text/javascript" src="../../node_modules/mdbootstrap/js/bootstrap.min.js"></script>
    <!-- MDB core JavaScript -->
    <script type="text/javascript" src="../../node_modules/mdbootstrap/js/mdb.min.js"></script>

    <script src="../../node_modules/sortablejs/Sortable.js"></script>

    <script>
        var preventDropOutside = Sortable.create(Left, {
            group: {
                name: 'shared',
                pull: 'clone' // To clone: set pull to 'clone'
            },
            animation: 150,
            onAdd: function ( /**Event*/ evt) {
                cloningElement(evt);
            },

            onChange: function ( /**Event*/ evt) {

            },
            onEnd: function ( /**Event*/ evt) {
                cloningElement(evt);
            }
        });

        function cloningElement(evt) {
            // remove all Event Listeners
            var old_element = evt.item
            var new_element = old_element.cloneNode(true);
            console.log('newElement', new_element);

            // clean older popper
            if (old_element.attrPanel && old_element.attrPanel.popper && old_element.attrPanel.popper.parentNode) {
                old_element.attrPanel.popper.parentNode.removeChild(old_element.attrPanel.popper);
            };

            if (!old_element.parentNode) {
                return;
            }
            
            old_element.parentNode.replaceChild(new_element, old_element);            

            let cover = document.getElementById('cover').cloneNode(true);

            let cover_template = document.querySelector('#example2popper1').content;
            // clone - the instance of cover_template - #document fragment 
            let clone = document.importNode(cover_template, true); 

            cover.appendChild(clone);
            let dynamicComponent = cover.querySelector('basiccomp-wc');
            dynamicComponent.addEventListener('wcbnt_click', function(el){
                console.log("I am here");
            })
            console.log('dynamic', cover.querySelector('basiccomp-wc'));

            document.body.appendChild(cover);

            cover.refNode = new_element;
            
            new_element.attrPanel = new Popper(new_element, cover, {
                placement: 'right',                
                onCreate: function (data) {
                    console.log('onCreate:', data, this);
                    document.querySelectorAll('cover').forEach(function (elem) {
                        if (elem.refNode !== new_element) {
                            elem.style.display = 'none';
                        }
                    })

                }
            });

            new_element.addEventListener('wc_click', function (el) {
                new_element.attrPanel.update();                
                // close all other popper
                document.querySelectorAll('cover').forEach(function(elem){
                    if (elem.refNode !== new_element){
                        elem.style.display = 'none';
                    }
                })
                // toggle popper of (this) new_element
                new_element.attrPanel.popper.style.display = new_element.attrPanel.popper.style.display ==
                    'none' ? 'block' : 'none'

            }, false);

        }

        new Sortable(Right, {
            group: {
                name: 'shared',
                pull: 'clone',
                put: false
            },
            animation: 150
        });

        function addSortableOutsideDrop(sortableInstance, callback) {
            var enableDragover = function (evt) {
                evt.preventDefault();
            };
            document.documentElement.addEventListener("dragover", enableDragover);

            var setToInsideDrop = function () {
                sortableInstance._isOutsideDrop = false;
            };
            // Set to inside drop if dropping inside the sortable element
            sortableInstance.el.addEventListener("drop", setToInsideDrop);
            // Set to inside drop if moving items across sortable lists
            Sortable.utils.on(sortableInstance.el, "add", setToInsideDrop);
            Sortable.utils.on(sortableInstance.el, "remove", setToInsideDrop);

            // On start, initialize to be outside drop
            Sortable.utils.on(sortableInstance.el, "start", function (evt) {
                sortableInstance._isOutsideDrop = true;
            });
            // Check if is still outside drop, and if it is, do callback
            Sortable.utils.on(sortableInstance.el, "end", function (evt) {
                if (sortableInstance._isOutsideDrop || typeof (sortableInstance._isOutsideDrop) == 'undefined')
                    callback(evt);
            });
        }

        addSortableOutsideDrop(preventDropOutside, function (evt) {
            var el = evt.item;
            if (el.attrPanel && el.attrPanel.popper) {
                el.attrPanel.popper.parentNode.removeChild(el.attrPanel.popper);
            }
            el.parentNode.removeChild(el);
            // alert('Trashed: ' + el.textContent);
        });

        // Utility region

    </script>

</body>

</html>